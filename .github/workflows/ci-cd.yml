name: CI/CD with GHCR Publishing

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write  # ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ test reports

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: true
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/reports/tests/test/
            build/test-results/test/
          retention-days: 30
          if-no-files-found: warn

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: true

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Build with Gradle
        run: ./gradlew buildFatJar --no-daemon

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: build/libs/*-all.jar
          retention-days: 7
          if-no-files-found: error

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [ test, build ]
    permissions:
      contents: read
      packages: write  # ÐÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð² GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: build/libs/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Ð›Ð¾Ð³Ð¸Ð½ Ð² GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ñ‚ÐµÐ³Ð¾Ð²
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ ÐŸÐ£Ð‘Ð›Ð˜ÐšÐÐ¦Ð˜Ð¯ Ð¾Ð±Ñ€Ð°Ð·Ð°
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.ci  # âœ… Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ CI-Ð²ÐµÑ€ÑÐ¸ÑŽ Ð±ÐµÐ· Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸ JAR
          push: true  # âœ… ÐŸÐ£Ð‘Ð›Ð˜ÐšÐ£Ð•Ðœ!
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð² Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCC_TOKEN }}

      # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° gcloud CLI
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # SSH Ð² VM Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· docker compose
      - name: Deploy to VM
        env:
          VM_NAME: ${{ secrets.GCC_VM_NAME }}
          VM_ZONE: ${{ secrets.GCC_VM_ZONE }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          UNKEY_ROOT_KEY: ${{ secrets.UNKEY_ROOT_KEY }}
          UNKEY_INTERNAL_KEY: ${{ secrets.UNKEY_INTERNAL_KEY }}
          DOCKER_IMAGE: ghcr.io/${{ github.repository }}:latest
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          if [ -z "$VM_NAME" ]; then
            echo "âŒ ERROR: GCC_VM_NAME secret is not set!"
            exit 1
          fi

          if [ -z "$VM_ZONE" ]; then
            echo "âŒ ERROR: GCC_VM_ZONE secret is not set!"
            exit 1
          fi

          echo "ðŸš€ Deploying to VM: $VM_NAME in zone $VM_ZONE"

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²
          TEMP_DIR=$(mktemp -d)

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          cp docker-compose.yml "$TEMP_DIR/"
          cp -r config "$TEMP_DIR/"

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .env Ñ„Ð°Ð¹Ð» Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
          cat > "$TEMP_DIR/.env" <<EOF
          BOT_TOKEN=${BOT_TOKEN}
          CHAT_ID=${CHAT_ID}
          SCHEDULER_CRON=0 0 * * * ?
          UNKEY_ROOT_KEY=${UNKEY_ROOT_KEY}
          UNKEY_INTERNAL_KEY=${UNKEY_INTERNAL_KEY}
          DOCKER_IMAGE=${DOCKER_IMAGE}
          EOF

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ tar Ð°Ñ€Ñ…Ð¸Ð²
          tar -czf currency-bot-deploy.tar.gz -C "$TEMP_DIR" .

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° VM
          echo "ðŸ“¦ Uploading files to VM..."
          gcloud compute scp currency-bot-deploy.tar.gz "$VM_NAME:/tmp/" \
            --zone="$VM_ZONE"

          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ð° VM
          echo "ðŸ”§ Deploying currency bot..."
          gcloud compute ssh "$VM_NAME" \
            --zone="$VM_ZONE" \
            --command="
              set -e

              echo 'ðŸ“‚ Creating deployment directory...'
              sudo mkdir -p /app/currency-bot

              echo 'ðŸ“¦ Extracting files...'
              sudo tar -xzf /tmp/currency-bot-deploy.tar.gz -C /app/currency-bot/
              sudo rm /tmp/currency-bot-deploy.tar.gz

              echo 'ðŸ”’ Setting permissions...'
              sudo chown -R root:root /app/currency-bot
              sudo chmod 600 /app/currency-bot/.env

              echo 'ðŸ“¦ Logging in to GitHub Container Registry...'
              echo '${{ secrets.GITHUB_TOKEN }}' | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin

              echo 'â¬‡ï¸  Pulling latest Docker image...'
              sudo docker pull ${DOCKER_IMAGE}

              echo 'ðŸ”„ Restarting services...'
              sudo sh -c 'cd /app/currency-bot && docker compose down' || true
              sudo sh -c 'cd /app/currency-bot && docker compose up -d'

              echo 'â³ Waiting for services to start...'
              sleep 10

              echo 'âœ… Deployment completed!'
            "

          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
          rm -rf "$TEMP_DIR" currency-bot-deploy.tar.gz

          echo "âœ… Successfully deployed to $VM_NAME"

      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¿Ð¾ÑÐ»Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ
      - name: Health check
        env:
          VM_NAME: ${{ secrets.GCC_VM_NAME }}
          VM_ZONE: ${{ secrets.GCC_VM_ZONE }}
        run: |
          echo "ðŸ” Running health checks..."

          gcloud compute ssh "$VM_NAME" \
            --zone="$VM_ZONE" \
            --command="
              echo 'ðŸ“Š Container status:'
              sudo sh -c 'cd /app/currency-bot && docker compose ps'

              echo ''
              echo 'ðŸ’¾ Volume usage:'
              sudo docker volume ls | grep currency-bot

              echo ''
              echo 'ðŸŒ API health:'
              curl -s http://localhost:8080/swagger | head -n 1 && echo 'âœ… API is responding' || echo 'âŒ API is not responding'
            "

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ð¢Ñ€ÐµÐ±ÑƒÐµÐ¼Ñ‹Ðµ GitHub Secrets:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# GCC_TOKEN              - Google Cloud credentials JSON
# GCC_VM_NAME            - Ð˜Ð¼Ñ VM Ð² GCP (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: proflyder-vm)
# GCC_VM_ZONE            - Ð—Ð¾Ð½Ð° VM (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: us-central1-a)
# BOT_TOKEN              - Telegram Bot Token
# CHAT_ID                - Telegram Chat ID
# UNKEY_ROOT_KEY         - Unkey Root Key Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
# UNKEY_INTERNAL_KEY     - Unkey Internal API Key
# GRADLE_ENCRYPTION_KEY  - (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) ÐšÐ»ÑŽÑ‡ Ð´Ð»Ñ ÐºÐµÑˆÐ° Gradle
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ðº VM:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ÐÐ° VM Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Docker Compose v2:
#   sudo apt update
#   sudo apt install docker-compose-plugin -y
#   docker compose version  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
#
# ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ: ÑÐ¼. INSTALL_DOCKER_COMPOSE_V2.md Ð² infra-monitoring
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ÐšÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´ÐµÐ¿Ð»Ð¾Ð¹:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² (test job)
# 2. Ð¡Ð±Ð¾Ñ€ÐºÐ° JAR (build job)
# 3. Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Docker Ð¾Ð±Ñ€Ð°Ð·Ð° Ð² GHCR (docker job)
# 4. Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° VM (deploy job):
#    - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ tar Ð°Ñ€Ñ…Ð¸Ð²Ð° Ñ docker-compose.yml Ð¸ config/
#    - ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð° Ð½Ð° VM Ñ‡ÐµÑ€ÐµÐ· gcloud compute scp
#    - SSH Ð½Ð° VM Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´:
#      * Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ /app/currency-bot
#      * Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð°
#      * Login Ð² GHCR
#      * Pull Ð¾Ð±Ñ€Ð°Ð·Ð°
#      * docker compose up -d
# 5. Health check
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
