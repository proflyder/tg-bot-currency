name: CI/CD with GHCR Publishing

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write  # –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ test reports

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: true
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/reports/tests/test/
            build/test-results/test/
          retention-days: 30
          if-no-files-found: warn

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: true

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Build with Gradle
        run: ./gradlew buildFatJar --no-daemon

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: build/libs/*-all.jar
          retention-days: 7
          if-no-files-found: error

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [ test, build ]
    permissions:
      contents: read
      packages: write  # –ù—É–∂–Ω–æ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: build/libs/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–≥–æ–≤
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # –°–±–æ—Ä–∫–∞ –∏ –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –æ–±—Ä–∞–∑–∞
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.ci  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º CI-–≤–µ—Ä—Å–∏—é –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–±–æ—Ä–∫–∏ JAR
          push: true  # ‚úÖ –ü–£–ë–õ–ò–ö–£–ï–ú!
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCC_TOKEN }}

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ gcloud CLI
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # SSH –≤ VM –∏ –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ gcloud compute ssh
      - name: Deploy to VM
        env:
          VM_NAME: ${{ secrets.GCC_VM_NAME }}
          VM_ZONE: ${{ secrets.GCC_VM_ZONE }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          UNKEY_ROOT_KEY: ${{ secrets.UNKEY_ROOT_KEY }}
          UNKEY_INTERNAL_KEY: ${{ secrets.UNKEY_INTERNAL_KEY }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
          if [ -z "$VM_NAME" ]; then
            echo "‚ùå ERROR: GCC_VM_NAME secret is not set!"
            echo "Please add GCC_VM_NAME to GitHub Secrets"
            exit 1
          fi

          if [ -z "$VM_ZONE" ]; then
            echo "‚ùå ERROR: GCC_VM_ZONE secret is not set!"
            echo "Please add GCC_VM_ZONE to GitHub Secrets"
            exit 1
          fi

          echo "üöÄ Deploying to VM: $VM_NAME in zone $VM_ZONE"

          # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞ VM —á–µ—Ä–µ–∑ gcloud compute ssh
          gcloud compute ssh "$VM_NAME" \
            --zone="$VM_ZONE" \
            --command="
              set -e
              echo 'üì¶ Logging in to GitHub Container Registry...'
              echo '${{ secrets.GITHUB_TOKEN }}' | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin

              echo '‚¨áÔ∏è  Pulling latest Docker image...'
              sudo docker pull ghcr.io/${{ github.repository }}:latest

              echo 'üõë Stopping old container...'
              sudo docker stop currency-bot || true
              sudo docker rm currency-bot || true

              echo 'üöÄ Starting new container...'
              sudo docker run -d \
                --name currency-bot \
                --restart unless-stopped \
                -p 8080:8080 \
                -v /var/log/currency-bot:/app/logs \
                -v /var/data/currency-bot:/app/data \
                -e BOT_TOKEN=$BOT_TOKEN \
                -e CHAT_ID=$CHAT_ID \
                -e SCHEDULER_CRON='0 0 * * * ?' \
                -e DATABASE_PATH=/app/data/currency-history \
                -e UNKEY_ROOT_KEY=$UNKEY_ROOT_KEY \
                -e INTERNAL_API_KEY=$UNKEY_INTERNAL_KEY \
                ghcr.io/${{ github.repository }}:latest

              echo '‚úÖ Deployment completed!'
              sudo docker ps | grep currency-bot
            "

          echo "‚úÖ Successfully deployed to $VM_NAME"

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
      - name: Health check
        env:
          VM_NAME: ${{ secrets.GCC_VM_NAME }}
          VM_ZONE: ${{ secrets.GCC_VM_ZONE }}
        run: |
          echo "üîç Checking container status..."
          gcloud compute ssh "$VM_NAME" \
            --zone="$VM_ZONE" \
            --command="sudo docker ps --filter name=currency-bot --format '{{.Status}}'"
